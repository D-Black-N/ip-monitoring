# IpMonitoring

## Содержание
1. [Задание](#задание)
2. [Декомпозиция задачи](#декомпозиция-задачи)
3. [Использованные инструменты](#использованные-инструменты)
4. [Старт приложения]()

## Задание
Предположим, нам нужна система мониторинга доступности IP-адресов. Напишем небольшое приложение, которое позволит регистрировать и удалять IP-адреса, а также выполнять проверку их доступности, где используя результаты проверки мы можем выполнить расчет статистики.

### API
* POST /ips - добавить адрес с параметрами (enabled: bool, ip: ipv4/ipv6 address)
* POST /ips/:id/enable - включить сбор статистики ip
* POST /ips/:id/disable - выключить сбор статистики ip
* GET /ips/:id/stats - получить статистику для адреса (time_from: datetime, time_to: datetime)
* DELETE /ips/:id - выключить сбор и удалить адрес

### Требования к задаче
* проверка должна выполняться раз в N времени (например, раз в минуту);
* расчет статистики целиком на уровне базы данных;
* расчет статистики должен включать в себя за период: среднее RTT (время отклика), минимальное RTT, максимальное RTT, медианное RTT, среднеквадратичное отклонение замеров RTT, процент потерянных пакетов ICMP до указанного адреса;
* не использовать rails, за исключением activesupport, Active Record;
* если проверка доступности занимает более одной секунды, то такая проверка считается неудачной (потеря пакетов) и должна быть прервана;
* если какую-то часть времени в выбранном периоде IP-адрес был вне расчета статистики (не был добавлен или был удален) — эту часть времени учитывать не нужно. Например, мы добавили IP-адрес 8.8.8.8 в 1 час, выключили в 2, включили в 3 и выключили в 4. Если запрашиваем статистику с 1 по 4 часа — надо объединить интервалы 1-2, 3-4 и отдать эту статистику по объединенному интервалу. Если IP-адрес не был в расчете статистики всё время или был настолько мало времени, что мы не успели сделать хотя бы 1 замер, – надо вернуть сообщение об ошибке.

### Мы хотим посмотреть, как ты
* используешь различные библиотеки;
* подбираешь стек для хранения и обсчёта статистики;
* работаешь с требованиями и кодом.

### Необязательно, но будет плюсом
* не использовать activesupport и Active Record;
* сделать запуск проекта с помощью docker compose;
* добавить поддержку IPv6 IP-адресов;
* настроить GitHub Actions (или любой другой CI, зависит от места размещения тестового задания) с запуском тестов.

## Глоссарий

**Round Trip Time** — это время, необходимое для прохождения данных в рамках сетевого запроса от начальной точки до места назначения и обратно. RTT является важным показателем для измерения производительности соединения во всех типах сетей. RTT используется для оценки скорости и надежности сетевых соединений.

## Декомпозиция задачи

### Определение сущностей
* **IP-адрес (ips):**
  * address - IP-адрес
  * enabled - вкл/выкл
  * deleted - удален/не удален
  * created_at - дата создания
  * updated_at - дата изменения

* **Проверка (Checks):**
  * rtt_ms - время отклика (в мс)
  * failed - удачная/неудачная проверка
  * ip_id - FK на IP-адрес
  * created_at - время создания

* **Статистика (Stats):**
  * average_rtt_ms - среднее RTT
  * min_rtt_ms - минимальное RTT
  * max_rtt_ms - максимальное RTT
  * median_rtt_ms - медианное RTT
  * rms_rtt_ms - среднеквадратичное отклонение замеров RTT
  * loss - процент потерянных пакетов ICMP
  * ip_id - FK на IP-адрес
  * created_at - время создания
  * time_from - время (от)
  * time_to - время (до)

### Реализация relations и repo
Прописать связи между таблицами и настроить слой обертку для работы с БД

### Добавление нового IP
1. Разработать эндпоинт
2. Разработать доменную операцию с проверками
3. Написать тесты

### Бизнес-процессы вкл/выкл сбора статистики
1. Разработать эндпоинт включения
2. Разработать эндпоинт выключения
3. Разработать доменную операцию вкл. с проверками
4. Разработать доменную операцию выкл. с проверками
5. Написать тесты

### Удаление IP
1. Разработать эндпоинт
2. Разработать доменную операцию с проверками
3. Написать тесты

### Реализация механизма проверок
1. Используем Daemon для фонового опроса доступности IP
2. Реализовать механизм проверки
3. Написать тесты

### Расчет статистики
1. Написать SQL запрос
2. Разработать эндпоинт
3. Разработать доменную операцию
2. Написать тесты

## Использованные инструменты
- Hanami 2.2 - фреймворк
- ROM - ORM для работы с БД
- Daemon - реализован механизм опроса активных IP-адресов
- Dry.rb - для удобной работы

Система построена в рамках архитектуры VSA, что позволяет без труда определять последовательность действий внутри каждого action

## Quick start
```bash
git clone git@github.com:D-Black-N/ip-monitoring.git
cd ip-monitoring
cp .env.example .env
docker compose build
docker compose run --rm server hanami db create
docker compose run --rm server hanami db migrate
docker compose up -d
```
Docker контейнеры:
* server - Hanami 2.2 API
* check_daemon - Процесс опроса IP
* db - База данных
